var modalSelector = '#personal-key-confirm';
var modal = new LoginGov.Modal({el: modalSelector });

var formEl = document.getElementById('confirm-key');
var successRedirectPath = "<%= sign_up_recovery_code_path %>";

var modalTrigger = document.querySelector('[data-toggle="modal"]');
var modalDismiss = document.querySelector('[data-dismiss="personal-key-confirm"]')

var recoveryWords = [].slice.call(document.querySelectorAll('[data-recovery]'));
var attempts = 0;

function show(event) {
  event.preventDefault();

  if (attempts < 3) {
    modal.show();
  } else {
    redirectToProfile();
  }
}

function hide() {
  modal.hide();
}

function redirectToProfile() {
  window.location = successRedirectPath;
}

modalTrigger.addEventListener('click', show);
modalDismiss.addEventListener('click', hide);

formEl.addEventListener('submit', function(event) {
  event.preventDefault();

  if (attempts === 3) {
    redirectToProfile();
  }

  var inputs = [].slice.call(event.target.elements).filter(function(element) {
    return element.type === 'text';
  });

  var invalidMatches = inputs.reduce(function(accumulator, input, index) {
    var value = input.value;

    if (input.value === recoveryWords[index].getAttribute('data-recovery')) {
      return accumulator;
    }

    accumulator.push(value);

    return accumulator;
  }, []);

  // a success
  if (!invalidMatches.length) {
    redirectToProfile();
  } else {
    attempts += 1;
  }
});
