#!/usr/bin/env ruby
require "pathname"

# path to your application root.
APP_ROOT = Pathname.new File.expand_path("../../", __FILE__)

def run(command)
  puts("* Running command: #{command}")
  abort "command failed (#{$?}): #{command}" unless system command
end

Dir.chdir APP_ROOT do
  # This script is a starting point to setup your application.
  # Add necessary setup steps to this file:

  puts %q[
   _             _
  | |           (_)
  | | ___   __ _ _ _ __    __ _  _____   __
  | |/ _ \ / _` | | '_ \  / _` |/ _ \ \ / /
  | | (_) | (_| | | | | || (_| | (_) \ V /
  |_|\___/ \__, |_|_| |_(_)__, |\___/ \_/
            __/ |          __/ |
           |___/          |___/
  ]

  # Rebuild the base, build, and production images
  # ** Eventually we will keep the `base` and `build` images in a separate repo,
  #   build them in a separate pipeline, and just pull them down for development
  #   Note: building the production image here is not necessary for development work
  { base: 'rails_base', build: 'rails_build', production: 'idp_app' }.each do |name, description|
    puts "== Building the #{name} Docker image =="
    run "docker build . --file #{name}.Dockerfile --tag identity-#{description} --no-cache"
  end
end
