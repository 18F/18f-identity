#!/usr/bin/env ruby

def run(command)
  abort "command failed (#{$?}): #{command}" unless system command
end

def equifax_gpg_private_exists?
  list_keys_output = `gpg --list-secret-keys`
  list_keys_output.include? 'login dot gov (development only) <logs@login.gov>'
end

def generate_equifax_gpg_private_key
  if equifax_gpg_private_exists?
    puts 'Equifax private key exists. Skipping.'
    return
  end
  parameters = '
    Key-Type: default
    Subkey-Type: default
    Name-Real: login dot gov
    Name-Comment: development only
    Name-Email: logs@login.gov
    Expire-Date: 0
    Passphrase: sekret
    # Do a commit here, so that we can later print "done"
    %commit
    %echo done
  '
  run "echo '#{parameters}' | gpg --batch --gen-key"
end

def export_equifax_gpg_public_key
  if File.exists? 'keys/equifax_gpg.pub.bin'
    puts 'Equifax public key exists. Skipping.'
    return
  end
  run 'gpg --export --output keys/equifax_gpg.pub.bin logs@login.gov'
end

puts "Note: This script is meant for local development use only."
puts "      Under no circumstances should this be used to generate keys"
puts "      for a production system."

generate_equifax_gpg_private_key
export_equifax_gpg_public_key
