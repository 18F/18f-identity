#!/bin/bash

# This script is called by identity-devops cookbooks as part of the deployment
# process. It runs build steps needed to complete building the application,
# such as vendoring ruby/nodejs libraries and compiling static assets.
# Then the deploy/activate script is called to instantiate live configuration
# and take steps at runtime.

set -euo pipefail

run() {
    echo >&2 "+ $*"
    "$@"
}

echo "deploy/build starting"
echo "HOME: ${HOME-}"
cd "$(dirname "$0")/.."

export IDP_SIDEKIQ_PRO=1

# secrets manager requires region to be set
az="$(run ec2metadata --availability-zone)"
export AWS_DEFAULT_REGION="${az::-1}"

# enable sidekiq pro
sidekiq_license="$(run aws secretsmanager get-secret-value --secret-id global/idp/sidekiq-pro --query SecretString --output text)"
bundle config enterprise.contribsys.com "$sidekiq_license"

set -x

env

id
which bundle

bundle_dir=/srv/idp/shared

# use system libxml2, not the one vendored with nokogiri
bundle config build.nokogiri --use-system-libraries

bundle install --deployment --jobs 4 \
    --path "$bundle_dir/bundle" \
    --binstubs "$bundle_dir/bin" \
    --without 'deploy development doc test'

bundle exec yarn install

set +x

echo "deploy/build finished"
